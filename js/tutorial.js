// Syst√®me de tutoriel
class TutorialSystem {
    constructor() {
        this.currentStep = 0;
        this.tutorialSteps = this.defineTutorialSteps();
        this.isActive = false;
    }

    // D√©finir les √©tapes du tutoriel
    defineTutorialSteps() {
        return [
            {
                title: 'Bienvenue dans le Gestionnaire de Guilde !',
                content: `
                    <p>Vous √™tes le gestionnaire d'une guilde d'aventuriers dans un univers m√©di√©val. 
                    Votre objectif est de recruter des troupes, les envoyer au combat, et faire progresser 
                    votre guilde jusqu'au rang S.</p>
                    
                    <p><strong>Objectifs :</strong></p>
                    <ul>
                        <li>Recruter des unit√©s vari√©es (corps √† corps, distance, magique)</li>
                        <li>Former des √©quipes avec des synergies</li>
                        <li>Combattre des ennemis pour gagner de l'or et de la r√©putation</li>
                        <li>Am√©liorer votre guilde via le magasin</li>
                        <li>Atteindre le rang S en affrontant des boss</li>
                    </ul>
                `,
                action: null
            },
            {
                title: 'Comprendre les Rangs',
                content: `
                    <p>Le syst√®me de rangs fonctionne ainsi :</p>
                    <p><strong>F- ‚Üí F ‚Üí F+ ‚Üí E- ‚Üí E ‚Üí E+ ‚Üí D- ‚Üí D ‚Üí D+ ‚Üí C- ‚Üí C ‚Üí C+ ‚Üí B- ‚Üí B ‚Üí B+ ‚Üí A- ‚Üí A ‚Üí A+ ‚Üí S</strong></p>
                    
                    <p>Pour progresser :</p>
                    <ul>
                        <li>Combats normaux : Gagnent des points de progression</li>
                        <li>Combats de boss : N√©cessaires pour passer au rang sup√©rieur</li>
                        <li>Chaque rang augmente la difficult√© et les r√©compenses</li>
                    </ul>
                `,
                action: null
            },
            {
                title: 'Recrutement d\'Unit√©s',
                content: `
                    <p>Le recrutement co√ªte 50üí∞ et vous propose 3 unit√©s al√©atoires.</p>
                    
                    <p><strong>Types d'unit√©s :</strong></p>
                    <ul>
                        <li><strong>Corps √† corps :</strong> √âp√©iste, Lancier, Barbare, Viking...</li>
                        <li><strong>Distance :</strong> Archer, Magicien Rouge, Magicien Bleu, Fronde...</li>
                        <li><strong>Magique :</strong> Mage, Sorcier, Mage Supr√™me...</li>
                    </ul>
                    
                    <p><strong>Raret√©s :</strong></p>
                    <ul>
                        <li>‚ö™ <strong>Commun :</strong> Unit√©s de base</li>
                        <li>üü¢ <strong>Peu commun :</strong> Unit√©s am√©lior√©es</li>
                        <li>üîµ <strong>Rare :</strong> Unit√©s sp√©ciales</li>
                        <li>üü£ <strong>√âpique :</strong> Unit√©s puissantes</li>
                        <li>üü° <strong>L√©gendaire :</strong> Unit√©s exceptionnelles</li>
                    </ul>
                `,
                action: 'highlight',
                target: '#recruit-btn'
            },
            {
                title: 'S√©lection d\'√âquipe',
                content: `
                    <p>Cliquez sur les unit√©s disponibles pour les s√©lectionner pour le combat.</p>
                    
                    <p><strong>Conseils :</strong></p>
                    <ul>
                        <li>S√©lectionnez au moins une unit√© avant de combattre</li>
                        <li>Les synergies d'√©quipe apparaissent automatiquement</li>
                        <li>Cliquez sur une unit√© s√©lectionn√©e pour la retirer</li>
                    </ul>
                `,
                action: 'highlight',
                target: '#available-troops'
            },
            {
                title: 'Synergies d\'√âquipe',
                content: `
                    <p>Les synergies sont des bonus automatiques bas√©s sur la composition de votre √©quipe :</p>
                    
                    <p><strong>Synergies de type :</strong></p>
                    <ul>
                        <li><strong>2+ Corps √† corps :</strong> +1 multiplicateur pour toutes les unit√©s corps √† corps</li>
                        <li><strong>2+ Distance :</strong> +2 multiplicateur pour toutes les unit√©s distance</li>
                    </ul>
                    
                    <p><strong>Synergies mixtes :</strong></p>
                    <ul>
                        <li><strong>2+ Corps √† corps + 1+ Distance :</strong> Les unit√©s distance gagnent +15 d√©g√¢ts et +1 multi</li>
                        <li><strong>2+ Distance + 1+ Corps √† corps :</strong> Les unit√©s corps √† corps gagnent +5 d√©g√¢ts et +3 multi</li>
                    </ul>
                `,
                action: 'highlight',
                target: '#synergies-display'
            },
            {
                title: 'Lancement d\'un Combat',
                content: `
                    <p>Une fois votre √©quipe s√©lectionn√©e, cliquez sur "Lancer Combat" pour commencer.</p>
                    
                    <p><strong>D√©roulement :</strong></p>
                    <ul>
                        <li>Chaque unit√© attaque automatiquement</li>
                        <li>Les d√©g√¢ts sont calcul√©s avec les synergies</li>
                        <li>Le combat se d√©roule en plusieurs manches</li>
                        <li>Objectif : Atteindre le nombre de d√©g√¢ts requis</li>
                    </ul>
                `,
                action: 'highlight',
                target: '#start-combat-btn'
            },
            {
                title: 'Combats de Boss',
                content: `
                    <p>Quand vous √™tes proche du rang sup√©rieur, vous affrontez un boss !</p>
                    
                    <p><strong>M√©caniques sp√©ciales :</strong></p>
                    <ul>
                        <li><strong>Golem de Pierre :</strong> Les unit√©s √† distance font 50% moins de d√©g√¢ts</li>
                        <li><strong>Seigneur des Ombres :</strong> Les unit√©s corps √† corps voient leur multiplicateur r√©duit de 50%</li>
                        <li><strong>Dragon Ancien :</strong> Les unit√©s magiques font 30% moins de d√©g√¢ts</li>
                        <li><strong>D√©mon Supr√™me :</strong> Toutes les unit√©s font 25% moins de d√©g√¢ts</li>
                    </ul>
                    
                    <p>Adaptez votre strat√©gie en cons√©quence !</p>
                `,
                action: null
            },
            {
                title: 'Le Magasin',
                content: `
                    <p>Apr√®s chaque combat, le magasin s'ouvre automatiquement.</p>
                    
                    <p><strong>Contenu :</strong></p>
                    <ul>
                        <li><strong>6 items al√©atoires :</strong> Unit√©s ou bonus d'√©quipement</li>
                        <li><strong>Pack al√©atoire :</strong> 3 choix, vous en s√©lectionnez 1</li>
                        <li><strong>Bonus :</strong> Am√©liorent temporairement vos unit√©s s√©lectionn√©es</li>
                    </ul>
                    
                    <p><strong>Types de bonus :</strong></p>
                    <ul>
                        <li>Bonus de d√©g√¢ts (+2, +3, +5, +10)</li>
                        <li>Bonus de multiplicateur (+1, +2, +3)</li>
                        <li>Bonus sp√©cifiques par type d'unit√©</li>
                        <li>Bonus universels pour toutes les unit√©s</li>
                    </ul>
                `,
                action: 'highlight',
                target: '#shop-btn'
            },
            {
                title: 'Gestion des Ressources',
                content: `
                    <p>Vous g√©rez deux ressources principales :</p>
                    
                    <p><strong>üí∞ Or :</strong></p>
                    <ul>
                        <li>Gagn√© en combattant</li>
                        <li>Utilis√© pour recruter (50üí∞) et acheter au magasin</li>
                        <li>Bonus de 50üí∞ lors des promotions de rang</li>
                    </ul>
                    
                    <p><strong>‚≠ê R√©putation :</strong></p>
                    <ul>
                        <li>Gagn√©e en combattant</li>
                        <li>Indique votre prestige dans le monde</li>
                        <li>Bonus de 10 points lors des promotions</li>
                    </ul>
                `,
                action: 'highlight',
                target: '.resources'
            },
            {
                title: 'Sauvegarde et Progression',
                content: `
                    <p>Votre progression est sauvegard√©e automatiquement dans votre navigateur.</p>
                    
                    <p><strong>Fonctionnalit√©s :</strong></p>
                    <ul>
                        <li><strong>Sauvegarde automatique :</strong> Vos actions sont sauvegard√©es</li>
                        <li><strong>Sauvegarde manuelle :</strong> Bouton "Sauvegarder" pour forcer la sauvegarde</li>
                        <li><strong>Chargement :</strong> Reprenez votre partie depuis le menu principal</li>
                        <li><strong>Nouvelle partie :</strong> Recommencez depuis le d√©but</li>
                    </ul>
                    
                    <p>Votre objectif final est d'atteindre le rang S et de devenir le plus grand gestionnaire de guilde !</p>
                `,
                action: 'highlight',
                target: '#save-btn'
            }
        ];
    }

    // D√©marrer le tutoriel
    startTutorial() {
        this.currentStep = 0;
        this.isActive = true;
        this.showCurrentStep();
    }

    // Afficher l'√©tape actuelle
    showCurrentStep() {
        const step = this.tutorialSteps[this.currentStep];
        const content = document.getElementById('tutorial-content');
        const prevBtn = document.getElementById('tutorial-prev');
        const nextBtn = document.getElementById('tutorial-next');

        // Mettre √† jour le contenu
        content.innerHTML = `
            <h4 style="color: #2d3436; margin-bottom: 15px;">${step.title}</h4>
            ${step.content}
        `;

        // Mettre √† jour les boutons
        prevBtn.disabled = this.currentStep === 0;
        nextBtn.textContent = this.currentStep === this.tutorialSteps.length - 1 ? 'Terminer' : 'Suivant';

        // Appliquer l'action si sp√©cifi√©e
        if (step.action === 'highlight' && step.target) {
            this.highlightElement(step.target);
        } else {
            this.removeHighlight();
        }
    }

    // Passer √† l'√©tape suivante
    nextStep() {
        if (this.currentStep < this.tutorialSteps.length - 1) {
            this.currentStep++;
            this.showCurrentStep();
        } else {
            this.endTutorial();
        }
    }

    // Passer √† l'√©tape pr√©c√©dente
    prevStep() {
        if (this.currentStep > 0) {
            this.currentStep--;
            this.showCurrentStep();
        }
    }

    // Terminer le tutoriel
    endTutorial() {
        this.isActive = false;
        this.removeHighlight();
        hideModal('tutorial-modal');
        // gameState.showNotification('Tutoriel termin√© ! Bonne chance !', 'success');
        
        // Marquer le tutoriel comme vu
        gameState.isFirstTime = false;
    }

    // Mettre en surbrillance un √©l√©ment
    highlightElement(selector) {
        this.removeHighlight();
        
        const element = document.querySelector(selector);
        if (element) {
            element.style.boxShadow = '0 0 20px rgba(255, 107, 107, 0.8)';
            element.style.border = '2px solid #ff6b6b';
            element.style.borderRadius = '8px';
            element.style.transition = 'all 0.3s ease';
            
            // Faire d√©filer vers l'√©l√©ment si n√©cessaire
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // Retirer la surbrillance
    removeHighlight() {
        document.querySelectorAll('*').forEach(element => {
            if (element.style.boxShadow && element.style.boxShadow.includes('rgba(255, 107, 107, 0.8)')) {
                element.style.boxShadow = '';
                element.style.border = '';
                element.style.borderRadius = '';
            }
        });
    }

    // Obtenir des conseils contextuels
    getContextualTip(elementId) {
        const tips = {
            'recruit-btn': 'Recrutez de nouvelles unit√©s pour renforcer votre guilde !',
            'start-combat-btn': 'S√©lectionnez vos troupes puis lancez le combat !',
            'shop-btn': 'Achetez des unit√©s et des bonus apr√®s chaque combat !',
            'save-btn': 'Sauvegardez votre progression r√©guli√®rement !',
            'available-troops': 'Cliquez sur les unit√©s pour les s√©lectionner !',
            'selected-troops': 'Vos troupes s√©lectionn√©es pour le combat !',
            'synergies-display': 'Les synergies d\'√©quipe apparaissent ici !'
        };
        
        return tips[elementId] || '';
    }
}

// Instance globale du syst√®me de tutoriel
const tutorialSystem = new TutorialSystem();

// Fonction pour initialiser le tutoriel (appel√©e depuis game.js)
function initTutorial() {
    tutorialSystem.startTutorial();
    
    // Ajouter les √©v√©nements de navigation
    document.getElementById('tutorial-prev').addEventListener('click', () => {
        tutorialSystem.prevStep();
    });
    
    document.getElementById('tutorial-next').addEventListener('click', () => {
        tutorialSystem.nextStep();
    });
}

// Fonction pour afficher des conseils contextuels
function showContextualTip(elementId) {
    const tip = tutorialSystem.getContextualTip(elementId);
    if (tip) {
        // gameState.showNotification(tip, 'info');
    }
}

// Ajouter des tooltips aux √©l√©ments importants
function addTooltips() {
    const tooltipElements = [
        'recruit-btn',
        'start-combat-btn', 
        'shop-btn',
        'save-btn'
    ];
    
    tooltipElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
            element.addEventListener('mouseenter', () => {
                if (gameState.isFirstTime) {
                    showContextualTip(elementId);
                }
            });
        }
    });
}

// Initialiser les tooltips quand le DOM est charg√©
document.addEventListener('DOMContentLoaded', () => {
    // Ajouter les tooltips apr√®s un d√©lai pour laisser le temps au jeu de se charger
    setTimeout(addTooltips, 1000);
}); 