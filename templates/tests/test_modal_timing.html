<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Timing de la Modal</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button.danger {
            background: #f44336;
        }
        .test-button.danger:hover {
            background: #da190b;
        }
        .debug-info {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .timing-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Timing de la Modal</h1>
        
        <div class="timing-info">
            <h3>Timing attendu de la modal de combat :</h3>
            <ul>
                <li><strong>D√©but du combat</strong> : Modal masqu√©e</li>
                <li><strong>Apr√®s chaque tour</strong> : Modal masqu√©e</li>
                <li><strong>Fin du combat (victoire)</strong> : Modal visible + popup de victoire</li>
                <li><strong>Fin du combat (d√©faite)</strong> : Modal masqu√©e (ferm√©e automatiquement)</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h3>Test 1: Apr√®s un Tour Normal</h3>
            <p>V√©rifier que la modal ne s'affiche pas apr√®s un tour qui n'est pas une victoire.</p>
            <button class="test-button" onclick="testNormalTurn()">Tour Normal</button>
            <div id="test1-result" class="debug-info"></div>
        </div>
        
        <div class="test-section">
            <h3>Test 2: Apr√®s une Victoire</h3>
            <p>V√©rifier que la modal s'affiche uniquement apr√®s une victoire.</p>
            <button class="test-button" onclick="testVictoryTurn()">Tour de Victoire</button>
            <div id="test2-result" class="debug-info"></div>
        </div>
        
        <div class="test-section">
            <h3>Test 3: Apr√®s une D√©faite</h3>
            <p>V√©rifier que la modal ne s'affiche pas apr√®s une d√©faite.</p>
            <button class="test-button" onclick="testDefeatTurn()">Tour de D√©faite</button>
            <div id="test3-result" class="debug-info"></div>
        </div>
        
        <div class="test-section">
            <h3>Test 4: S√©rie de Tours</h3>
            <p>Simuler plusieurs tours pour v√©rifier que la modal ne s'affiche qu'√† la fin.</p>
            <button class="test-button" onclick="testMultipleTurns()">S√©rie de Tours</button>
            <div id="test4-result" class="debug-info"></div>
        </div>
        
        <div class="test-section">
            <h3>√âtat Actuel</h3>
            <div id="current-state" class="debug-info"></div>
        </div>
    </div>

    <script type="module">
        import { GameState } from '../js/modules/GameState.js';
        
        let gameState;
        
        // Initialiser le jeu
        function initGame() {
            gameState = new GameState();
            gameState.newGame();
            updateCurrentState();
        }
        
        // Mettre √† jour l'affichage de l'√©tat actuel
        function updateCurrentState() {
            const stateDiv = document.getElementById('current-state');
            if (gameState) {
                stateDiv.innerHTML = `
                    <strong>√âtat du jeu :</strong><br>
                    Rang: ${gameState.rank}<br>
                    Or: ${gameState.gold}<br>
                    Combat actif: ${gameState.currentCombat ? gameState.currentCombat.isActive : 'Non'}<br>
                    D√©g√¢ts totaux: ${gameState.currentCombat ? gameState.currentCombat.totalDamage : '0'}<br>
                    Objectif: ${gameState.currentCombat ? gameState.currentCombat.targetDamage : '0'}<br>
                    Tour actuel: ${gameState.currentCombat ? gameState.currentCombat.round : '0'}<br>
                    <br>
                    <strong>Modal de combat :</strong><br>
                    Visible: ${document.getElementById('combat-modal') && 
                        document.getElementById('combat-modal').style.display === 'flex' ? 'Oui' : 'Non'}
                `;
            }
        }
        
        // Fonction utilitaire pour v√©rifier l'√©tat de la modal
        function checkModalState() {
            const combatModal = document.getElementById('combat-modal');
            return {
                exists: !!combatModal,
                visible: combatModal && (combatModal.style.display === 'flex' || combatModal.classList.contains('active')),
                display: combatModal ? combatModal.style.display : 'N/A',
                hasActiveClass: combatModal ? combatModal.classList.contains('active') : false
            };
        }
        
        // Test 1: Tour normal
        window.testNormalTurn = function() {
            const resultDiv = document.getElementById('test1-result');
            resultDiv.innerHTML = 'Test en cours...';
            
            try {
                // D√©marrer un combat si n√©cessaire
                if (!gameState.currentCombat.isActive) {
                    gameState.startNewCombat();
                }
                
                // V√©rifier l'√©tat avant le tour
                const modalBefore = checkModalState();
                
                // S√©lectionner des troupes et ex√©cuter un tour
                if (gameState.combatTroops.length > 0) {
                    gameState.selectedTroops = [gameState.combatTroops[0]];
                }
                
                const result = gameState.executeCombatTurn();
                
                // Attendre un peu pour que l'animation se termine
                setTimeout(() => {
                    const modalAfter = checkModalState();
                    
                    resultDiv.innerHTML = `
                        <strong>R√©sultat du tour normal :</strong><br>
                        <br>
                        <strong>Avant le tour :</strong><br>
                        Modal visible: ${modalBefore.visible ? 'Oui' : 'Non'}<br>
                        <br>
                        <strong>Apr√®s le tour :</strong><br>
                        Modal visible: ${modalAfter.visible ? 'Oui (ERREUR)' : 'Non (CORRECT)'}<br>
                        <br>
                        <strong>D√©tails du tour :</strong><br>
                        Tour ex√©cut√©: ${result.success ? 'Oui' : 'Non'}<br>
                        D√©g√¢ts: ${result.damage}<br>
                        D√©g√¢ts totaux: ${result.total}<br>
                        Objectif: ${gameState.currentCombat.targetDamage}<br>
                        <br>
                        <strong>R√©sultat :</strong> ${modalAfter.visible ? '‚ùå ERREUR - Modal ne devrait pas s\'afficher' : '‚úÖ CORRECT - Modal masqu√©e'}
                    `;
                    
                    updateCurrentState();
                }, 2000);
                
            } catch (error) {
                resultDiv.innerHTML = `Erreur: ${error.message}`;
            }
        };
        
        // Test 2: Tour de victoire
        window.testVictoryTurn = function() {
            const resultDiv = document.getElementById('test4-result');
            resultDiv.innerHTML = 'Test en cours...';
            
            try {
                // D√©marrer un combat si n√©cessaire
                if (!gameState.currentCombat.isActive) {
                    gameState.startNewCombat();
                }
                
                // V√©rifier l'√©tat avant le tour
                const modalBefore = checkModalState();
                
                // S√©lectionner des troupes et ex√©cuter un tour
                if (gameState.combatTroops.length > 0) {
                    gameState.selectedTroops = [gameState.combatTroops[0]];
                }
                
                // Simuler une victoire
                gameState.currentCombat.totalDamage = gameState.currentCombat.targetDamage;
                gameState.endCombat(true);
                
                // Attendre un peu pour que tout se mette √† jour
                setTimeout(() => {
                    const modalAfter = checkModalState();
                    const victoryBox = document.querySelector('.victory-summary-box');
                    
                    resultDiv.innerHTML = `
                        <strong>R√©sultat du tour de victoire :</strong><br>
                        <br>
                        <strong>Avant le tour :</strong><br>
                        Modal visible: ${modalBefore.visible ? 'Oui' : 'Non'}<br>
                        <br>
                        <strong>Apr√®s la victoire :</strong><br>
                        Modal visible: ${modalAfter.visible ? 'Oui (CORRECT)' : 'Non (ERREUR)'}<br>
                        Popup de victoire: ${victoryBox ? 'Pr√©sente (CORRECT)' : 'Absente (ERREUR)'}<br>
                        <br>
                        <strong>R√©sultat :</strong> ${modalAfter.visible && victoryBox ? '‚úÖ CORRECT - Modal et popup visibles' : '‚ùå ERREUR - Modal ou popup manquante'}
                    `;
                    
                    updateCurrentState();
                }, 1000);
                
            } catch (error) {
                resultDiv.innerHTML = `Erreur: ${error.message}`;
            }
        };
        
        // Test 3: Tour de d√©faite
        window.testDefeatTurn = function() {
            const resultDiv = document.getElementById('test3-result');
            resultDiv.innerHTML = 'Test en cours...';
            
            try {
                // D√©marrer un combat si n√©cessaire
                if (!gameState.currentCombat.isActive) {
                    gameState.startNewCombat();
                }
                
                // V√©rifier l'√©tat avant le tour
                const modalBefore = checkModalState();
                
                // Simuler une d√©faite (trop de tours)
                gameState.currentCombat.round = gameState.currentCombat.maxRounds;
                gameState.endCombat(false);
                
                // Attendre un peu pour que tout se mette √† jour
                setTimeout(() => {
                    const modalAfter = checkModalState();
                    
                    resultDiv.innerHTML = `
                        <strong>R√©sultat du tour de d√©faite :</strong><br>
                        <br>
                        <strong>Avant le tour :</strong><br>
                        Modal visible: ${modalBefore.visible ? 'Oui' : 'Non'}<br>
                        <br>
                        <strong>Apr√®s la d√©faite :</strong><br>
                        Modal visible: ${modalAfter.visible ? 'Oui (ERREUR)' : 'Non (CORRECT)'}<br>
                        <br>
                        <strong>R√©sultat :</strong> ${modalAfter.visible ? '‚ùå ERREUR - Modal ne devrait pas s\'afficher' : '‚úÖ CORRECT - Modal masqu√©e'}
                    `;
                    
                    updateCurrentState();
                }, 1000);
                
            } catch (error) {
                resultDiv.innerHTML = `Erreur: ${error.message}`;
            }
        };
        
        // Test 4: S√©rie de tours
        window.testMultipleTurns = async function() {
            const resultDiv = document.getElementById('test4-result');
            resultDiv.innerHTML = 'Test en cours...';
            
            try {
                // D√©marrer un combat
                gameState.startNewCombat();
                const modalAtStart = checkModalState();
                
                // Ex√©cuter plusieurs tours
                let turnResults = [];
                for (let i = 0; i < 3; i++) {
                    if (gameState.combatTroops.length > 0) {
                        gameState.selectedTroops = [gameState.combatTroops[0]];
                    }
                    
                    const result = gameState.executeCombatTurn();
                    turnResults.push({
                        turn: i + 1,
                        damage: result.damage,
                        total: result.total,
                        modalVisible: checkModalState().visible
                    });
                    
                    // Attendre un peu entre les tours
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                // Simuler une victoire
                gameState.currentCombat.totalDamage = gameState.currentCombat.targetDamage;
                gameState.endCombat(true);
                
                setTimeout(() => {
                    const modalAtEnd = checkModalState();
                    const victoryBox = document.querySelector('.victory-summary-box');
                    
                    resultDiv.innerHTML = `
                        <strong>R√©sultat de la s√©rie de tours :</strong><br>
                        <br>
                        <strong>Au d√©but :</strong><br>
                        Modal visible: ${modalAtStart.visible ? 'Oui (ERREUR)' : 'Non (CORRECT)'}<br>
                        <br>
                        <strong>Apr√®s chaque tour :</strong><br>
                        ${turnResults.map(r => `Tour ${r.turn}: Modal visible = ${r.modalVisible ? 'Oui (ERREUR)' : 'Non (CORRECT)'} (d√©g√¢ts: ${r.damage})`).join('<br>')}<br>
                        <br>
                        <strong>√Ä la fin (victoire) :</strong><br>
                        Modal visible: ${modalAtEnd.visible ? 'Oui (CORRECT)' : 'Non (ERREUR)'}<br>
                        Popup de victoire: ${victoryBox ? 'Pr√©sente (CORRECT)' : 'Absente (ERREUR)'}<br>
                        <br>
                        <strong>R√©sultat global :</strong> ${!modalAtStart.visible && !turnResults.some(r => r.modalVisible) && modalAtEnd.visible && victoryBox ? '‚úÖ CORRECT - Timing parfait' : '‚ùå ERREUR - Probl√®me de timing'}
                    `;
                    
                    updateCurrentState();
                }, 1000);
                
            } catch (error) {
                resultDiv.innerHTML = `Erreur: ${error.message}`;
            }
        };
        
        // Initialiser le jeu au chargement
        document.addEventListener('DOMContentLoaded', function() {
            initGame();
        });
    </script>
</body>
</html> 